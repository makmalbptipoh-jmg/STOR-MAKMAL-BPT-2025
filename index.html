<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stor Makmal JMG BPT</title>

  <!-- Bulma CSS Framework -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"/>
  
  <!-- Font Awesome untuk ikon carian -->
  <script src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

  <!-- Google Font: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
  
  <style>
    /* Gradient untuk header */
    .hero.is-primary {
      background: linear-gradient(135deg, #16a085, #1abc9c); /* hijau makmal */
    }

    /* Styling teks */
    h1.title {
      font-family: 'Poppins', sans-serif;
      font-size: 2.2rem;
      font-weight: 600;
      color: #ffffff;
      text-shadow: 1px 2px 4px rgba(0,0,0,0.25); /* lebih jelas di atas gradient */
    }
    
    /* Style untuk search bar */
    .search-container {
      margin-top: 1rem;
      margin-right: 1rem;
    }

    /* Styling untuk hasil carian dalam modal */
    .search-result-item {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid #dbdbdb;
      cursor: pointer; /* jadikan item boleh klik */
      transition: background-color 0.2s;
    }
    .search-result-item:hover {
      background-color: #f5f5f5; /* kesan hover */
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-item p {
      font-weight: bold;
    }
    .search-result-item span {
      font-style: italic;
      color: #7a7a7a;
    }
  </style>
</head>

<body class="theme-forest">
  <section class="hero is-primary is-bold">
    <div class="hero-body">
      <div class="container has-text-centered">
        <h1 class="title">Stor Makmal JMG BPT</h1>
      </div>
    </div>
  </section>

  <!-- Login first -->
  <div id="login-box" class="container m-4 pl-4">
    <div class="field">
      <label class="label">Kata Laluan</label>
      <div class="control">
        <input class="input" style="width:250px" type="password" id="password-input" placeholder="Masukkan kata laluan">
      </div>
    </div>
    <button class="button is-primary" id="login-button">Masuk</button>
    <p id="login-msg" class="has-text-danger mt-2"></p>
  </div>

  <!-- Borang (hidden until password is correct) -->
  <form id="form" class="container m-4 pl-4" style="display:none;">
    <!-- Bar carian di bahagian atas kanan (dipindahkan di sini) -->
    <div class="container search-container">
      <div class="field has-addons is-pulled-right">
        <div class="control has-icons-left">
          <input class="input" type="text" id="item-search-input" placeholder="Cari Kod/Nama Item...">
          <span class="icon is-small is-left">
            <i class="fas fa-search"></i>
          </span>
        </div>
      </div>
    </div>

    <!-- Logout button -->
    <div class="field is-grouped is-right">
      <div class="control">
        <button type="button" class="button is-success" id="logout-button">Log keluar</button>
      </div>
    </div>

    <div class="field">
      <label class="label">Nama Pengguna</label>
      <div class="control">
        <div class="select is-fullwidth">
          <select name="Nama_Pengguna" required>
            <option value="">-- Sila Pilih Nama Pengguna --</option>
            <option>MOHAMAD ASWANDI BIN ARIFF</option>
            <option>MOHD FUZI BIN HASHIM</option>
            <option>MOHD FAHAMI BIN ABAS</option>
            <option>PASUPATI A/L SUBRAMANIAM</option>
            <option>SHARIZAN BIN IBRAHIM</option>
            <option>AZRUL BIN ARIFFIN</option>
            <option>MOHD ZAHAR BIN IBRAHIM</option>
            <option>NURUL HUSNA BINTI ISMAYATIM</option>
            <option>AKRIMI MASUA BINTI MOHAMAD</option>
            <option>MOHAMMAD NUR HAFIZ BIN HAMID</option>
            <option>TAMILARASI A/P GANASAN</option>
            <option>MARIHAM BINTI YAACOB</option>
            <option>NAZILAH BINTI AHMAD NAZRI</option>
            <option>KHATIB BIN MD YAN</option>
            <option>ABDUL RANI BIN ABU BAKAR</option>
            <option>FAHIMAH ZAIDAH BINTI ZAINUL ABIDIN</option>
            <option>SURAYA BINTI ABDULLAH SANI</option>
            <option>SAEDA A/P ANJANG</option>
            <option>WAN MOHD SUBRI BIN WAN ABDULLAH</option>
            <option>MUHAMAD ARIF BIN ABDUL KARIM</option>
            <option>WAN ERDALINA BINTI WAN DALI</option>
            <option>AMIRUL ZAKI BIN ISHAK</option>
            <option>AMIRUL ZAHIM BIN MD ZAKARIA</option>
            <option>MAJDI BIN BALI</option>
            <option>CLYDERICK BONAVENTURE</option>
            <option>SURAYA BINTI ANUAR</option>
            <option>NUR AMIRAH IZZATI BINTI MAT AROP</option>
            <option>FAKHRUL ANWAR BIN NOOR ARMAN</option>
            <option>SITI YUS SYAFEERA BINTI SAPUAN</option>
            <option>NUR ADILAH BINTI MAT NOR</option>
            <option>RUBENS CHIA</option>
            <option>WAN MOHD FAIZ BIN WAN MASRI</option>
            <option>NUR EFFA IZATI BINTI ABDUL HAMID</option>
            <option>SYAHRUL NIZAM BIN MOHD ZURAINI</option>
            <option>SAIFUL BAHARIL BIN ABU BAKAR</option>
            <option>RASHID BIN SHAPEE</option>
            <option>MOHAMAD HANIF BIN MUSLIMAN</option>
            <option>MOHD EZRULFAZLY BIN LEMAN</option>
            <option>FARAH NADIRAH BINTI SHALUDIN</option>
          </select>
        </div>
      </div>
    </div>

    <div class="field">
      <label class="label">Unit Makmal</label>
      <div class="control">
        <div class="select is-fullwidth">
          <select name="Unit_Makmal" required>
            <option value="">-- Sila Pilih Unit --</option>
            <option value="MBA">MBA</option>
            <option value="MPI">MPI</option>
            <option value="BA">BA</option>
          </select>
        </div>
      </div>
    </div>
    
    <div class="field">
      <label class="label">Kod Item</label>
      <div class="control">
        <div class="select is-fullwidth">
          <select name="Kod_Item" id="kod-item-select" required>
            <option value="">-- Sila Pilih Kod Item --</option>
          </select>
        </div>
      </div>
    </div>

    <div class="field">
      <label class="label">Nama Item</label>
      <div class="control">
        <div class="select is-fullwidth">
          <select name="Nama_Item" id="nama-item-select" required>
            <option value="">-- Nama Item --</option>
          </select>
        </div>
      </div>
    </div>

    <div class="field">
      <label class="label">Kuantiti</label>
      <div class="control">
        <input class="input" type="number" name="Kuantiti" required min="1" max="20" placeholder="1 - 20" />
      </div>
    </div>

    <div class="field">
      <label class="label">Tujuan Kegunaan</label>
      <div class="control">
        <textarea class="textarea" name="Tujuan_Kegunaan" placeholder="Maklumat Kegunaan"></textarea>
      </div>
    </div>

    <div class="field">
      <label class="label">Setuju Terma</label>
      <div class="control">
        <label class="checkbox">
          <input type="checkbox" name="Setuju_Terma" value="yes" required /> Saya bersetuju dengan terma dan syarat
        </label>
      </div>
    </div>

    <div class="field is-grouped">
      <div class="control">
        <button class="button is-primary" type="submit" id="submit-button">Hantar</button>
      </div>
      <div class="control">
        <button class="button is-danger" type="button" id="cancel-button">Batal</button>
      </div>
    </div>
  </form>

  <!-- Mesej status -->
  <div id="message" class="container" style="display:none;"></div>
  
  <!-- Modal untuk memaparkan hasil carian -->
  <div class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Hasil Carian</p>
        <button class="delete" aria-label="close" id="close-modal-button"></button>
      </header>
      <section class="modal-card-body" id="modal-content-body">
        <!-- Hasil carian akan disuntik di sini -->
      </section>
      <footer class="modal-card-foot is-justify-content-flex-end">
        <button class="button is-success" id="ok-modal-button">OK</button>
      </footer>
    </div>
  </div>

  <script>
    // Gerbang kata laluan
    const loginBox = document.getElementById("login-box");
    const loginBtn = document.getElementById("login-button");
    const loginMsg = document.getElementById("login-msg");
    const formBox  = document.getElementById("form");
    const CORRECT_PASSWORD = "Lab2025";
    const SESSION_KEY = "bpt_logged_in";

    // Fungsi untuk memaparkan borang
    function showForm(){
      loginBox.style.display = "none";
      formBox.style.display = "block";
    }

    // Pulihkan sesi jika pengguna sudah log masuk
    if (sessionStorage.getItem(SESSION_KEY) === "1") {
      showForm();
    }

    loginBtn.addEventListener("click", function(){
      const pw = document.getElementById("password-input").value;
      if (pw === CORRECT_PASSWORD){
        sessionStorage.setItem(SESSION_KEY, "1");
        showForm();
        loginMsg.textContent = "";
        document.getElementById("password-input").value = "";
      } else {
        loginMsg.textContent = "Kata laluan salah!";
      }
    });

    // Log keluar
    const logoutBtn = document.getElementById("logout-button");
    logoutBtn.addEventListener("click", () => {
      sessionStorage.removeItem(SESSION_KEY);
      formBox.style.display = "none";
      loginBox.style.display = "block";
    });

    // Data Item penuh
    const allItems = [
      { code: "ACID001", name: "NITRIC ACID 69% 2.5 LITER" },
      { code: "ACID002", name: "NITRIC ACID 68% 2.5 LITER" },
      { code: "ACID003", name: "NITRIC ACID 65% 2.5 LITER" },
      { code: "ACID004", name: "NITRIC ACID 65% 1 LITER" },
      { code: "ACID005", name: "HYDROCHLORIC ACID 37% 2.5LITER" },
      { code: "ACID006", name: "HYDROCHLORIC ACID CARBOY 33% 25LITER" },
      { code: "ACID007", name: "HYDROFLUORIC ACID 49% 2.5LITER" },
      { code: "ACID008", name: "HYDROFLUORIC ACID 48% 2.5LITER" },
      { code: "ACID009", name: "SULFURIC ACID 98% 2.5LITER" },
      { code: "ACID010", name: "SULFURIC ACID 95-97% 2.5LITER" },
      { code: "ACID011", name: "ORTHO PHOSPHORIC ACID 85% 2.5LITER" },
      { code: "ACID012", name: "SULFUROUS ACID 5-6% 2.5LITER" },
      { code: "ACID013", name: "PERCHLORIC ACID 70-72% 2.5LITER" },
      { code: "ACID014", name: "PERCHLORIC ACID 70% 2.5LITER" },
      { code: "ACID015", name: "HYDROBROMIC ACID 48-50%" },
      { code: "ACID016", name: "ACETIC ACID GLACIAL 99.8% 2.5LITER" },
      { code: "ACID017", name: "ACETIC ACID GLACIAL CARBOY 99.8% 25 LITER" },
      { code: "ACID018", name: "THIOGLYCOLIC ACID 1KG" },
      { code: "ACID019", name: "MERCAPTOACETIC ACID 98%" },
      { code: "ACID020", name: "ACETIC ANHYDRIDE" },
      { code: "ALC001", name: "ETHANOL 99.8% 2.5LITER" },
      { code: "ALC002", name: "ETHANOL 70% 2.5LITER" },
      { code: "ALC003", name: "ETHANOL ABSOLUTE 2.5L" },
      { code: "ALC004", name: "ETHYL ALCOHOL 2.8 L" },
      { code: "ALC005", name: "GLYCEROL 2.5 L" },
      { code: "ALC006", name: "METHANOL 2.5L" },
      { code: "ALC007", name: "METHYL ALCOHOL ANHYDROUS 4L" },
      { code: "ALC008", name: "AMYL ALCOHOL" },
      { code: "ALC009", name: "1-BUTANOL" },
      { code: "ALC010", name: "2-METHYLBUTAN-2-O1" },
      { code: "ALC011", name: "BENZENE" },
      { code: "ALC012", name: "DIETHYLETHER 99%" },
      { code: "KET001", name: "ACETONE 2.5 LITER" },
      { code: "KET002", name: "ACETONE 25 LITER" },
      { code: "KET003", name: "FORMALDEHYDE SOLUTION MIN 37% 2.5L" },
      { code: "IND001", name: "4-AMINO-3-HYDROXYL-1-NAPTHALINSULFONIC ACID" },
      { code: "IND002", name: "BARIUM DIPHENYLAMINE SULFONIC INDICATOR, 0.2%" },
      { code: "IND003", name: "FERRIC INDICATOR SOLUTION" },
      { code: "IND004", name: "BROMOCRESOL GREEN SOLN. 0.2G/100ML" },
      { code: "IND005", name: "4% PHENOLPHTHALEIN 4G/100ML" },
      { code: "OXI001", name: "HYDROGEN PEROXIDE 3%" },
      { code: "OXI002", name: "HYDROGEN PEROXIDE 30% 1 LITER" },
      { code: "OXI003", name: "HYDROGEN PEROXIDE 30%" },
      { code: "OXI004", name: "POTASSIUM PERMANGANATE" },
      { code: "OXI005", name: "SODIUM HYPOCHLORITE SOLUTION 15%" },
      { code: "STD001", name: "LEAD STANDARD, 1000PPM" },
      { code: "STD002", name: "TIN STANDARD, 1000PPM" },
      { code: "STD003", name: "MANGANESE STANDARD, 1000PPM" },
      { code: "STD004", name: "CALCIUM, 1000PPM" },
      { code: "STD005", name: "CADMIUM, 1000PPM" },
      { code: "STD006", name: "ALUMINIUM, 1000PPM" },
      { code: "STD007", name: "MANGANESE, 1000PPM" },
      { code: "STD008", name: "LEAD, 1000PPM" },
      { code: "STD009", name: "CHROMIUM, 1000PPM" },
      { code: "STD010", name: "MERKURI, 1000PPM" },
      { code: "STD011", name: "ARSENIC, 1000PPM" },
      { code: "STD012", name: "SILVER, 1000PPM" },
      { code: "STD013", name: "IRON, 1000PPM" },
      { code: "STD014", name: "TITANIUM, 1000PPM" },
      { code: "STD015", name: "POTASSIUM, 1000PPM" },
      { code: "STD016", name: "ZINC, 1000PPM" },
      { code: "STD017", name: "SILICON, 1000PPM" },
      { code: "STD018", name: "NICKEL, 1000PPM" },
      { code: "STD019", name: "SODIUM, 1000PPM" },
      { code: "STD020", name: "COPPER,1000PPM" },
      { code: "STD021", name: "PHOSPOROUS, 1000PPM" },
      { code: "STD022", name: "SELENIUM, 1000PPM" },
      { code: "STD023", name: "TIN, 1000PPM" },
      { code: "STD024", name: "ZIRCONIUM, 1000PPM" },
      { code: "STD025", name: "MAGNESIUM, 1000PPM" },
      { code: "STD026", name: "AU,AG,CU,ZN,NI,FE 100PPM" },
      { code: "OTH001", name: "AMMONIA SOLUTION 25% 2.5LITER" },
      { code: "OTH002", name: "POLYETHOXY CHAIN" },
      { code: "OTH003", name: "PYRIDINE 2.5 LITER" },
      { code: "OTH004", name: "PETROLEUM SPIRIT 40-60" },
      { code: "OTH005", name: "n-HEXANE 2.5 L" },
      { code: "OTH006", name: "DICHLOROMETHANE 2.5L" },
      { code: "OTH007", name: "ETHYLENE GLYCOL 2.5 L" },
      { code: "OTH008", name: "3,5,5-TRIMETHYL-1-HEXANOL TECHN 85%" },
      { code: "CLN001", name: "Baldi" },
      { code: "CLN002", name: "Bahan Pencuci (Jenis serbuk)" },
      { code: "CLN003", name: "Bahan Pencuci (Cecair)" },
      { code: "CLN004", name: "Pencuci tangan Dettol" },
      { code: "CLN005", name: "Hand Sanitizer" },
      { code: "CLN006", name: "Tuala Good Morning" },
      { code: "CLN007", name: "Plastic sampah" },
      { code: "CLN008", name: "Mop" },
      { code: "PPE001", name: "Apron plastik" },
      { code: "PPE002", name: "Sarung tangan getah kuning" },
      { code: "PPE003", name: "Eye wash" },
      { code: "BRU001", name: "Berus M.G Chemical" },
      { code: "BRU002", name: "Copper wire brush (tembaga)" },
      { code: "BRU003", name: "Brass wire brush" },
      { code: "BRU004", name: "Justman brush" },
      { code: "BRU005", name: "Berus Cat (Catherine Brush)" },
      { code: "BRU006", name: "Horse hair Brush" },
      { code: "LAB001", name: "Spatula lab" },
      { code: "LAB002", name: "Spatula straight edged" },
      { code: "LAB003", name: "Sample Boat" },
      { code: "LAB004", name: "Bulat Clay" },
      { code: "LAB005", name: "Fisher brand Beaker tongs safety" },
      { code: "LAB006", name: "Bulb Pipette 30ml" },
      { code: "STK001", name: "Stiker Putih Pendaftaran Sampel MBA" },
      { code: "STK002", name: "Stiker Riben" },
      { code: "STK003", name: "Stiker Bulat" },
      { code: "OTH009", name: "Mini Drawer" },
      { code: "OTH010", name: "Tayar Troli" },
      { code: "OTH011", name: "Pemetik api" },
      { code: "OTH012", name: "Eubiq plug Extention" },
      { code: "OTH013", name: "Molykote" },
      { code: "OTH014", name: "Container" },
      { code: "OTH015", name: "Pembalut Plastik" }
    ];

    // Hubungan antara dropdown dan carian
    const codeSelect = document.getElementById('kod-item-select');
    const nameSelect = document.getElementById('nama-item-select');
    const searchInput = document.getElementById('item-search-input');
    
    // Rujukan borang dan butang
    const form = document.getElementById("form");
    const submitButton = document.getElementById("submit-button");
    const cancelButton = document.getElementById("cancel-button");
    const messageDiv = document.getElementById("message");

    // Rujukan elemen modal carian
    const searchModal = document.getElementById('search-modal');
    const modalContent = document.getElementById('modal-content-body');
    const closeModalBtn = document.getElementById('close-modal-button');
    const okModalBtn = document.getElementById('ok-modal-button');
    const modalBackground = document.querySelector('.modal-background');

    const scriptURL = "https://script.google.com/macros/s/AKfycbyAtEO6DNB0y_1a2TOrvyA2YwDMGOtZ7C9rtwjliXre44tiT3S71RBZBrBtlYnwGcddVg/exec";

    // Isi pilihan dalam kedua-dua dropdown dengan semua item pada mulanya
    function populateSelects(items) {
      codeSelect.innerHTML = '<option value="">-- Sila Pilih Kod Item --</option>';
      nameSelect.innerHTML = '<option value="">-- Nama Item --</option>';

      items.forEach(item => {
        const codeOption = document.createElement('option');
        codeOption.value = item.code;
        codeOption.textContent = item.code;
        codeSelect.appendChild(codeOption);

        const nameOption = document.createElement('option');
        nameOption.value = item.name;
        nameOption.textContent = item.name;
        nameSelect.appendChild(nameOption);
      });
    }

    // Panggilan awal untuk mengisi dropdown dengan semua item
    populateSelects(allItems);

    // Fungsi baharu untuk memilih item dari modal dan mengisi borang
    function selectItem(code, name) {
      codeSelect.value = code;
      nameSelect.value = name;
      searchModal.classList.remove('is-active');
    }

    // Fungsi untuk memaparkan hasil carian dalam modal
    function showSearchResults(results) {
      if (results.length === 0) {
        modalContent.innerHTML = '<p class="has-text-centered">Tiada hasil carian ditemui.</p>';
      } else {
        let htmlContent = '';
        results.forEach(item => {
          // Tambah 'onclick' event ke setiap item hasil carian
          htmlContent += `
            <div class="search-result-item" onclick="selectItem('${item.code}', '${item.name.replace(/'/g, "\\'")}')">
              <p>${item.name}</p>
              <span>Kod: ${item.code}</span>
            </div>
          `;
        });
        modalContent.innerHTML = htmlContent;
      }
      searchModal.classList.add('is-active');
    }

    // Dengar input pada bar carian dan papar hasil dalam modal
    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      if (searchTerm.length > 0) {
        const filteredItems = allItems.filter(item => 
          item.name.toLowerCase().includes(searchTerm) || 
          item.code.toLowerCase().includes(searchTerm)
        );
        showSearchResults(filteredItems);
      } else {
        // Jika kotak carian kosong, tutup modal
        searchModal.classList.remove('is-active');
      }
    });

    // Pautkan Kod Item dengan Nama Item apabila pilihan Kod berubah
    codeSelect.addEventListener('change', () => {
      const selectedCode = codeSelect.value;
      const selectedItem = allItems.find(item => item.code === selectedCode);
      if (selectedItem) {
        nameSelect.value = selectedItem.name;
      } else {
        nameSelect.value = "";
      }
    });

    // Pautkan Nama Item dengan Kod Item apabila pilihan Nama berubah
    nameSelect.addEventListener('change', () => {
      const selectedName = nameSelect.value;
      const selectedItem = allItems.find(item => item.name === selectedName);
      if (selectedItem) {
        codeSelect.value = selectedItem.code;
      } else {
        codeSelect.value = "";
      }
    });
    
    // Fungsi untuk memaparkan mesej status
    function setMessage(type, text){
      messageDiv.innerHTML = '<div class="notification is-'+type+'">'+text+'</div>';
      messageDiv.style.display = "block";
    }

    // Penghantaran borang
    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      if (sessionStorage.getItem(SESSION_KEY) !== "1") {
        setMessage("danger", "Sila log masuk dahulu.");
        return;
      }
      setMessage("info", "Sedang menghantar...");
      submitButton.disabled = true;
      submitButton.classList.add("is-loading");

      try {
        const formData = new FormData(form);
        const formDataObj = {};
        for (let [key, value] of formData.entries()) formDataObj[key] = value;
        
        // Dapatkan nama dan kuantiti item
        const item = formDataObj["Nama_Item"];
        const qty  = formDataObj["Kuantiti"];

        const response = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify(formDataObj),
          headers: { "Content-Type": "text/plain;charset=utf-8" }
        });

        const data = await response.json();

        if (data.status === "success") {
          setMessage("success", `Permintaan berjaya! Item: ${item}, Kuantiti: ${qty}`);
          form.reset();
        } else {
          throw new Error(data.message || "Gagal dihantar");
        }
      } catch (error) {
        setMessage("danger", "Ralat: " + error.message);
      } finally {
        submitButton.disabled = false;
        submitButton.classList.remove("is-loading");
        setTimeout(() => { messageDiv.style.display = "none"; }, 4000);
      }
    });

    // Butang batal
    cancelButton.addEventListener("click", function () {
      form.reset();
      messageDiv.style.display = "none";
    });

    // Event listener untuk menutup modal
    const closeModals = () => {
      searchModal.classList.remove('is-active');
    };

    closeModalBtn.addEventListener('click', closeModals);
    okModalBtn.addEventListener('click', closeModals);
    modalBackground.addEventListener('click', closeModals);
  </script>
</body>
</html>

